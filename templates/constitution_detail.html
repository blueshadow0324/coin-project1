{% extends "base.html" %}
{% block content %}

<h2>{{ constitution.title }}</h2>
<p>{{ constitution.content }}</p>

<p>
  Status:
  {% if status == "passed" %}
    <span class="badge bg-success">Passed</span>
  {% elif status == "closed" %}
    <span class="badge bg-danger">Voting Closed</span>
  {% else %}
    <span class="badge bg-warning">Not voted yet</span>
  {% endif %}
</p>

<hr>

<h4>Live Vote Summary</h4>
<div class="progress" style="height: 30px;">
  <div class="progress-bar bg-success" role="progressbar"
       style="width: {{ (yes_seats / total_seats) * 100 }}%"
       aria-valuenow="{{ yes_seats }}" aria-valuemin="0" aria-valuemax="{{ total_seats }}">
    Yes
  </div>
  <div class="progress-bar bg-danger" role="progressbar"
       style="width: {{ (no_seats / total_seats) * 100 }}%"
       aria-valuenow="{{ no_seats }}" aria-valuemin="0" aria-valuemax="{{ total_seats }}">
    No
  </div>
  <div class="progress-bar bg-secondary" role="progressbar"
       style="width: {{ (abstain_seats / total_seats) * 100 }}%"
       aria-valuenow="{{ abstain_seats }}" aria-valuemin="0" aria-valuemax="{{ total_seats }}">
    Abstain
  </div>
</div>

<div class="d-flex justify-content-between mt-1">
  <small class="text-success">YES: {{ yes_seats }} seats</small>
  <small class="text-danger">NO: {{ no_seats }} seats</small>
  <small class="text-secondary">Abstain: {{ abstain_seats }} seats</small>
</div>

<p class="mt-2">
  Total seats: {{ total_seats }}<br>
  Majority needed: {{ majority_needed }} seats
</p>

<hr>

{% if g.user and g.user.party and status != "closed" %}
  <form method="POST">
    <button type="submit" name="vote" value="yes" class="btn btn-success">Yes</button>
    <button type="submit" name="vote" value="no" class="btn btn-danger">No</button>
    <button type="submit" name="vote" value="abstain" class="btn btn-secondary">Abstain</button>
  </form>
{% elif status == "closed" %}
  <p class="text-danger"><strong>Voting for this constitution has ended.</strong></p>
{% else %}
  <p><em>Only users belonging to a party can vote.</em></p>
{% endif %}

<hr>

<h5>Party Votes</h5>
<ul>
  {% for v in votes %}
    {% set party = (calculate_riksdag_seats() | selectattr('id', 'equalto', v.party_id) | list).0 %}
    <li>{{ party.party if party else "Party " ~ v.party_id }} voted {{ v.vote_choice|capitalize }}</li>
  {% endfor %}
</ul>

{% if g.user.username == ADMIN_USERNAME %}
  <form method="POST" action="{{ url_for('admin_delete_const', constitution_id=constitution.id) }}" style="display:inline;">
    <button type="submit" class="btn btn-danger mt-3" onclick="return confirm('Are you sure you want to delete this constitution?');">Delete Constitution</button>
  </form>
  <form method="POST" action="{{ url_for('admin_pass_const', constitution_id=constitution.id) }}" style="display:inline;">
    <button type="submit" class="btn btn-success mt-3" onclick="return confirm('Force pass this constitution?');">Force Pass</button>
  </form>
{% endif %}

{% endblock %}
