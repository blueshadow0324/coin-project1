{% extends "base.html" %}

{% block content %}
<h2>Dino Game</h2>
<p>Press <strong>Space</strong> to start or jump!</p>

<canvas id="dinoGame" width="800" height="200" style="border:1px solid #000;"></canvas>
<p id="scoreDisplay">Score: 0</p>
<p id="gameOverMsg" style="color:red; font-weight:bold;"></p>

<h3>Your Highscore: {{ user_highscore }}</h3>

<h3>üèÜ Leaderboard</h3>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Rank</th>
      <th>Player</th>
      <th>Highscore</th>
    </tr>
  </thead>
  <tbody>
    {% for entry in leaderboard %}
    <tr>
      <td>{{ loop.index }}</td>
      <td>{{ entry.username }}</td>
      <td>{{ entry.high }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
const canvas = document.getElementById("dinoGame");
const ctx = canvas.getContext("2d");

let gameRunning = false;
let score = 0;
let frameCount = 0;
let speed = 5;

// Ground level
const groundY = 180;

// Dino setup
let dino = { 
    x: 50, 
    y: groundY, 
    width: 20, 
    height: 20, 
    vy: 0, 
    gravity: 1, 
    jump: -15 
};

let obstacles = [];

// Handle space key
document.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
        if (!gameRunning) startGame();
        else if (dino.y >= groundY) dino.vy = dino.jump;
    }
});

function startGame() {
    gameRunning = true;
    score = 0;
    frameCount = 0;
    speed = 5;
    obstacles = [];
    dino.y = groundY;
    dino.vy = 0;
    document.getElementById("gameOverMsg").innerText = "";
    requestAnimationFrame(gameLoop);
}

function generateObstacle() {
    const height = Math.random() * 40 + 20;
    obstacles.push({ x: canvas.width, y: groundY + dino.height - height, width: 20, height });
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw ground
    ctx.fillStyle = "black";
    ctx.fillRect(0, groundY + dino.height, canvas.width, 2);

    // Dino physics
    dino.vy += dino.gravity;
    dino.y += dino.vy;
    if (dino.y > groundY) { dino.y = groundY; dino.vy = 0; }

    ctx.fillStyle = "green";
    ctx.fillRect(dino.x, dino.y, dino.width, dino.height);

    // Generate obstacles
    if (frameCount % 90 === 0) generateObstacle();

    // Draw obstacles and check collision
    ctx.fillStyle = "brown";
    obstacles.forEach((obs, index) => {
        obs.x -= speed;
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);

        if (dino.x < obs.x + obs.width &&
            dino.x + dino.width > obs.x &&
            dino.y < obs.y + obs.height &&
            dino.y + dino.height > obs.y) {
            gameOver();
        }

        if (obs.x + obs.width < 0) obstacles.splice(index, 1);
    });

    // Update score
    score += 1;
    document.getElementById("scoreDisplay").innerText = "Score: " + score;

    // Increase speed over time
    if (score % 200 === 0) speed += 1;

    frameCount++;
    if (gameRunning) requestAnimationFrame(gameLoop);
}

function gameOver() {
    gameRunning = false;
    document.getElementById("gameOverMsg").innerText = "Game Over! Final Score: " + score;

    // Save score
    fetch("/dino/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ score: score })
    })
    .then(res => res.json())
    .then(data => {
        console.log("Score saved:", data);
        setTimeout(() => location.reload(), 1000); // reload leaderboard after saving
    });
}
</script>
{% endblock %}
