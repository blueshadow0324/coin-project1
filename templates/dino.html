{% extends "base.html" %}

{% block content %}
<h2>Dino Game</h2>
<p>Press <strong>Space</strong> to start or jump!</p>
<canvas id="dinoGame" width="800" height="200" style="border:1px solid #000;"></canvas>
<p id="scoreDisplay">Score: 0</p>

<h3>Your Highscore: {{ user_highscore }}</h3>

<script>
const canvas = document.getElementById("dinoGame");
const ctx = canvas.getContext("2d");

let gameRunning = false;
let score = 0;
let frameCount = 0;
let speed = 5;

let dino = { x: 50, y: 150, width: 20, height: 20, vy: 0, gravity: 1, jump: -15 };
let obstacles = [];

// Handle space key
document.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
        if (!gameRunning) startGame();
        else if (dino.y >= 150) dino.vy = dino.jump;
    }
});

function startGame() {
    gameRunning = true;
    score = 0;
    frameCount = 0;
    speed = 5;
    obstacles = [];
    dino.y = 150;
    dino.vy = 0;
    requestAnimationFrame(gameLoop);
}

function generateObstacle() {
    const height = Math.random() * 40 + 20; // random obstacle height
    obstacles.push({ x: canvas.width, y: 200 - height, width: 20, height });
}

function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dino physics
    dino.vy += dino.gravity;
    dino.y += dino.vy;
    if (dino.y > 150) { dino.y = 150; dino.vy = 0; }

    ctx.fillStyle = "green";
    ctx.fillRect(dino.x, dino.y, dino.width, dino.height);

    // Generate obstacles
    if (frameCount % 90 === 0) generateObstacle();

    // Draw obstacles and check collision
    ctx.fillStyle = "brown";
    obstacles.forEach((obs, index) => {
        obs.x -= speed;
        ctx.fillRect(obs.x, obs.y, obs.width, obs.height);

        if (dino.x < obs.x + obs.width &&
            dino.x + dino.width > obs.x &&
            dino.y < obs.y + obs.height &&
            dino.y + dino.height > obs.y) {
            gameOver();
        }

        if (obs.x + obs.width < 0) obstacles.splice(index, 1);
    });

    // Update score
    score += 1;
    document.getElementById("scoreDisplay").innerText = "Score: " + score;

    // Increase speed over time for difficulty
    if (score % 200 === 0) speed += 1;

    frameCount++;
    if (gameRunning) requestAnimationFrame(gameLoop);
}

function gameOver() {
    gameRunning = false;

    // Send score to backend
    fetch("/dino/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ score: score })
    })
    .then(res => res.json())
    .then(data => {
        console.log(data);
        location.reload(); // reload page to update highscore
    });
}
</script>
{% endblock %}
