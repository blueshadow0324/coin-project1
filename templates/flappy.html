{% extends "base.html" %}

{% block content %}
<h1>Flappy Bird - Spela och tjäna coins!</h1>

<p>Ditt saldo: <strong>{{ user.coins }} coins</strong></p>

<canvas id="gameCanvas" width="320" height="480" style="border:1px solid #000;"></canvas>

<p>Poäng: <span id="score">0</span></p>
<p>Senaste spel: <span id="recentScore">-</span></p>
<p>Högsta poäng (all-time): <span id="highScore">0</span></p>

<button id="startBtn">Starta spelet</button>
<p id="gameMessage" style="color: red; font-weight: bold; margin-top: 10px;"></p>

<h2>Leaderboard - High Score</h2>
{% if highscore_list %}
<ol>
{% for username, high in highscore_list %}
    <li>{{ username }} — {{ high }} coins</li>
{% endfor %}
</ol>
{% else %}
<p>Inga poäng registrerade än.</p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const bird = { x: 60, y: 240, w: 34, h: 24, gravity: 0.5, lift: -10, velocity: 0 };
    const pipes = [];
    const pipeGap = 120;
    const pipeSpeed = 2;
    const groundHeight = 80;
    let frame = 0;
    let score = 0;
    let running = false;
    let gameInterval;

    let highScore = {{ user_highscore }};
    const scoreElem = document.getElementById('score');
    const recentScoreElem = document.getElementById('recentScore');
    const highScoreElem = document.getElementById('highScore');
    const startBtn = document.getElementById('startBtn');
    const gameMessage = document.getElementById('gameMessage');

    highScoreElem.innerText = highScore;

    function drawBackground() {
        ctx.fillStyle = "#70c5ce";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function drawGround() {
        ctx.fillStyle = "#ded895";
        ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
    }

    function drawBird() {
        ctx.fillStyle = "yellow";
        ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
        ctx.fillStyle = "orange";
        ctx.fillRect(bird.x + bird.w - 6, bird.y + bird.h/2 - 4, 6, 4);
    }

    function drawPipes() {
        ctx.fillStyle = "#4caf50";
        pipes.forEach(p => {
            ctx.fillRect(p.x, 0, p.w, p.top);
            ctx.fillRect(p.x, canvas.height - groundHeight - p.bottom, p.w, p.bottom);
        });
    }

    function resetGame() {
        bird.y = 240;
        bird.velocity = 0;
        pipes.length = 0;
        score = 0;
        frame = 0;
        running = false;
        scoreElem.innerText = score;
        gameMessage.innerText = '';
        clearInterval(gameInterval);
        drawStartMenu();
    }

    function drawStartMenu() {
        drawBackground();
        drawGround();
        drawBird();
        ctx.fillStyle = "white";
        ctx.font = "24px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Flappy Bird", canvas.width / 2, canvas.height / 2 - 50);
        ctx.fillText("Tryck på SPACE för att starta", canvas.width / 2, canvas.height / 2);
    }

    function updateBird() {
        bird.velocity += bird.gravity;
        bird.velocity *= 0.9;
        bird.y += bird.velocity;
        if (bird.y + bird.h > canvas.height - groundHeight) gameOver();
        if (bird.y < 0) bird.y = 0;
    }

    function updatePipes() {
        if (frame % 90 === 0) {
            const top = Math.random() * (canvas.height - groundHeight - pipeGap - 50) + 20;
            pipes.push({ x: canvas.width, w: 50, top: top, bottom: canvas.height - groundHeight - top - pipeGap, passed: false });
        }

        pipes.forEach(p => {
            p.x -= pipeSpeed;

            // Collision
            if (
                bird.x < p.x + p.w &&
                bird.x + bird.w > p.x &&
                (bird.y < p.top || bird.y + bird.h > canvas.height - groundHeight - p.bottom)
            ) {
                gameOver();
            }

            // Score
            if (!p.passed && bird.x > p.x + p.w) {
                score++;
                p.passed = true;
                scoreElem.innerText = score;
            }
        });

        while (pipes.length && pipes[0].x + pipes[0].w < 0) pipes.shift();
    }

    function gameLoop() {
        if (!running) return;
        frame++;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground();
        drawPipes();
        drawGround();
        drawBird();
        updateBird();
        updatePipes();
    }

    function gameOver() {
        clearInterval(gameInterval);
        running = false;
        gameMessage.innerText = "Game Over! Klicka på 'Starta spelet' för att spela igen.";
        recentScoreElem.innerText = score;

        if (score > highScore) {
            highScore = score;
            highScoreElem.innerText = highScore;
        }

        // Send score to server (1 score = 1 coin)
        fetch("{{ url_for('flappy_submit') }}", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({score: score})
        }).catch(() => console.error('Fel vid sparande av poängen.'));
    }

    startBtn.addEventListener('click', () => {
        if (running) return;
        resetGame();
        running = true;
        bird.velocity = 0;
        gameInterval = setInterval(gameLoop, 20);
    });

    window.addEventListener('keydown', e => {
        if (e.code === "Space") {
            if (!running) startBtn.click();
            else bird.velocity = bird.lift;
        }
    });

    drawStartMenu();
});
</script>
{% endblock %}
